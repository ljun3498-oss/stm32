# FOC 电机控制 - 啸叫问题诊断指南

## 问题描述
电机在闭环模式下发出啸叫声，不转动。开环模式正常运行。

## 根本原因分析
**啸叫的原因**：d轴（励磁轴）没有正确对齐到电机的磁场方向

在FOC中：
- **d轴** = 励磁轴，应该与转子磁场对齐
- **q轴** = 转矩轴，垂直于d轴
- 如果d轴对齐错误 → PI控制器输出错误的电压 → 电机无法产生有效转矩 → 发出啸叫

## 最新改进（已实施）

### 1. 减少编码器误触发
- **问题**：编码器故障检测设置为2次（100μs）太敏感
- **表现**：频繁在闭环/开环之间切换，导致控制不稳定
- **解决**：改为10次检测（500μs）
- **位置**：FOC_CurrentLoop_Execute() 中的 zero_count > 10

### 2. 简化OLED显示
- **目的**：减少I2C开销，避免与FOC中断竞争
- **显示内容**：
  - 第1行：机械角度(0-360°) + 电机速度(RPM)
  - 第2行：d轴电流 (d轴应该 ≈ 0 mA)
  - 第3行：q轴电流 (q轴应该 = 转矩参考)

### 3. 诊断变量输出
- 新增 `g_diag_Id_q15` 和 `g_diag_Iq_q15`
- 在FOC中实时捕获d-q轴电流值
- 用于判断Park变换是否正确对齐

## 诊断步骤

### 第一步：观察OLED显示
**启动电机后，按PB13启动FOC**

**正常表现应该是**：
```
行1: 角度 = 逐渐增加 (表示电机转动)
     速度 = 逐渐增加
行2: d轴电流 ≈ 0~100 mA (应该很小)  
行3: q轴电流 = 2000~3000 mA (参考值)
```

**问题表现**：
1. **d轴电流很大** (例如 > 500 mA)
   - 原因：Park变换没有对齐，励磁轴指向错误
   - 症状：电机啸叫，不转动

2. **q轴电流很小或为0**
   - 原因：转矩参考没有被应用
   - 解决：检查 `Iq_ref_q15 = 3000` 是否被设置

3. **d、q都在变化**
   - 原因：整个Park变换的θ角度可能反向或有90°偏差
   - 需要调整Park变换的相位

### 第二步：检查电机接线
**验证三相电机线序 (A、B、C)是否正确**

如果硬接反了，会导致：
- 电机转向错误
- d轴无法建立
- 发出啸叫

**解决**：交换任意两相接线（例如B和C互换）

### 第三步：验证Park变换相位
如果d轴电流仍然很大，可能需要校准θ角度

**可尝试的修改**（在FOC_CurrentLoop_Execute中）：

```c
// 原始：
uint16_t theta_angle = (uint16_t)((uint32_t)g_cached_angle_tenths * 65536U / 3600U);

// 尝试 +90°：
uint16_t theta_angle = (uint16_t)((uint32_t)g_cached_angle_tenths * 65536U / 3600U + 16384);

// 尝试 -90°：
uint16_t theta_angle = (uint16_t)((uint32_t)g_cached_angle_tenths * 65536U / 3600U - 16384);
```

**测试哪个能让电机正常转动**

### 第四步：验证Clarke/Park算法
**检查变换实现是否正确**

在 main.c 中：
- Clarke变换: `clarke_transform_q15()` ~第658行
- Park变换: `park_transform_q15()` ~第670行
- 反Park变换: `inv_park_transform_q15()` ~第683行

标准公式应该是：
```
Park：
  d = α*cos(θ) + β*sin(θ)
  q = -α*sin(θ) + β*cos(θ)

反Park：
  α = d*cos(θ) - q*sin(θ)
  β = d*sin(θ) + q*cos(θ)
```

## 快速检查清单

- [ ] OLED 显示 "d:" 和 "q:" 电流值
- [ ] 启动电机，观察d轴电流是否 < 200 mA
- [ ] 观察q轴电流是否 > 1000 mA
- [ ] 电机是否平稳旋转（不啸叫）
- [ ] 速度是否随时间增加
- [ ] 角度是否正确增加

## 如果仍然不工作

1. **检查编码器**
   - 确认编码器能正确读取（用之前的测试代码）
   - 检查I2C通信是否稳定

2. **检查PI控制器参数**
   - 当前设置：KP=0.1, KI=0.005
   - 可尝试降低KI防止积分饱和

3. **检查ADC电流测量**
   - 零点应该 ≈ 2.5V (ADC读值 ≈ 3150)
   - 各相的偏移是否一致

4. **考虑降低参考电流**
   - 当前 `Iq_ref_q15 = 3000` (对应 ~1.4A)
   - 尝试降低到 1500 或 2000

## 文件位置

- FOC算法: [User/main.c](User/main.c#L766) FOC_CurrentLoop_Execute()
- Park变换: [User/main.c](User/main.c#L670) park_transform_q15()
- OLED显示: [User/main.c](User/main.c#L910) 显示d-q轴电流
- 编码器故障检测: [User/main.c](User/main.c#L776) zero_count阈值

## 预期结果

按照上述步骤调试后：
- 电机应该平稳运行，无啸叫
- OLED应该显示合理的d-q轴电流值
- 速度和角度应该稳定增加或保持设定值
